<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Whatsapp Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos gerais e para consistência do tema */
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('/draw.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* Efeito de Vidro para Containers */
        .glass-container {
            background: rgba(28, 37, 54, 0.6); /* Fundo escuro semitransparente */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px); /* Suporte para Safari */
            border-radius: 1rem; /* 16px */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Efeito de Vidro para Botões */
        .btn-glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .btn-glass:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        /* Estilo para Inputs */
        .input-glass {
            background-color: rgba(0, 0, 0, 0.2) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        .log-success { background-color: rgba(46, 125, 50, 0.8); color: #fff; }
        .log-error { background-color: rgba(198, 40, 40, 0.8); color: #fff; }
        .log-warn { background-color: rgba(249, 168, 37, 0.8); color: #000; }

        /* Estilos para a tabela de contatos no modal */
        .contacts-table { border-collapse: collapse; width: 100%; }
        .contacts-table th, .contacts-table td {
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px;
            text-align: left;
            background-color: rgba(45, 55, 72, 0.8);
            color: #e2e8f0;
        }
        .contacts-table th {
            background-color: rgba(26, 32, 44, 0.9);
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <!-- Container de Autenticação -->
    <div id="auth-container" class="w-full max-w-sm">
        <!-- Secção de Login -->
        <div id="login-screen">
            <form id="login-form" onsubmit="handleLogin(event)"
                class="glass-container p-6 md:p-8 space-y-6">
                <h1 class="text-2xl font-bold text-center text-white">Login</h1>
                <p class="text-center text-gray-300 text-sm">Faça login para continuar</p>
                <div>
                    <label for="login-username" class="block text-sm font-medium text-gray-300">Utilizador</label>
                    <input type="text" id="login-username" placeholder="Seu utilizador" required
                        class="input-glass mt-1 w-full rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-300">Senha</label>
                    <input type="password" id="login-password" placeholder="Sua senha" required
                        class="input-glass mt-1 w-full rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="login-error" class="text-red-400 text-sm text-center h-4"></div>
                <button type="submit"
                    class="w-full btn-glass text-white font-bold py-2 px-4 rounded-md">Entrar</button>
                <p class="text-center text-sm text-gray-300 pt-2">
                    Não tem uma conta? <a href="#" onclick="toggleAuthScreens(event)"
                        class="font-semibold text-blue-400 hover:underline">Registe-se</a>
                </p>
            </form>
        </div>

        <!-- Secção de Registo -->
        <div id="register-screen" class="hidden">
            <form id="register-form" onsubmit="handleRegister(event)"
                class="glass-container p-6 md:p-8 space-y-6">
                <h1 class="text-2xl font-bold text-center text-white">Registar</h1>
                <p class="text-center text-gray-300 text-sm">Crie uma nova conta</p>
                <div>
                    <label for="register-username" class="block text-sm font-medium text-gray-300">Utilizador</label>
                    <input type="text" id="register-username" placeholder="Escolha um utilizador" required
                        class="input-glass mt-1 w-full rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-300">Senha</label>
                    <input type="password" id="register-password" placeholder="Crie uma senha" required
                        class="input-glass mt-1 w-full rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="register-error" class="text-red-400 text-sm text-center h-4"></div>
                <div id="register-success" class="text-green-400 text-sm text-center h-4"></div>
                <button type="submit"
                    class="w-full btn-glass text-white font-bold py-2 px-4 rounded-md">Criar Conta</button>
                <p class="text-center text-sm text-gray-300 pt-2">
                    Já tem uma conta? <a href="#" onclick="toggleAuthScreens(event)"
                        class="font-semibold text-blue-400 hover:underline">Faça Login</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Container Principal da Aplicação -->
    <div id="app-container" class="hidden w-full max-w-6xl glass-container p-6 md:p-8">
        <!-- Cabeçalho com botão de Logout -->
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold">Whatsapp Assistant</h1>
            <button onclick="logout()"
                class="btn-glass text-white font-bold py-2 px-4 rounded-md text-sm">Sair</button>
        </div>

        <!-- Menu -->
        <div class="flex justify-around mb-6 border-b border-gray-700/50 pb-4">
            <a href="#dashboard" class="menu-link px-4 py-2 rounded-md hover:bg-white/10 transition-colors duration-200">Dashboard</a>
            <a href="#disparo" class="menu-link px-4 py-2 rounded-md hover:bg-white/10 transition-colors duration-200">Disparo</a>
            <a href="#retorno" class="menu-link px-4 py-2 rounded-md hover:bg-white/10 transition-colors duration-200">Logs</a>
            <a href="#whatsapp-lateral" class="menu-link px-4 py-2 rounded-md hover:bg-white/10 transition-colors duration-200">WhatsApp</a>
        </div>

        <!-- Secção de Disparo -->
        <div class="sidebar space-y-4" id="disparo">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">1. Escolha uma lista (.csv, .xlsx)</label>
                <input type="file" id="planilha" class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white file:hover:bg-indigo-700 file:cursor-pointer" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" onchange="previewPlanilha(event)">
                <button onclick="abrirPreview()" class="mt-2 w-full btn-glass text-white font-bold py-2 px-4 rounded-md">Pré-visualizar Lista</button>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">2. Digite o índice dos clientes:</label>
                <div class="flex space-x-2">
                    <input type="number" placeholder="Início" id="valor1" min="1" class="input-glass w-1/2 rounded-md px-3 py-2 text-white placeholder-gray-400">
                    <input type="number" placeholder="Final" id="valor2" min="1" class="input-glass w-1/2 rounded-md px-3 py-2 text-white placeholder-gray-400">
                </div>
            </div>
            <div>
                <label for="mensagem" class="block text-sm font-medium text-gray-300">3. Mensagem</label>
                <p class="text-xs text-gray-400 mb-1">Use: @nome @nomecompleto @cpf @agencia</p>
                <textarea id="mensagem" placeholder="Digite seu texto aqui." rows="5" class="input-glass w-full rounded-md px-3 py-2 text-white placeholder-gray-400"></textarea>
            </div>
            <div>
                <label for="mediaFile" class="block text-sm font-medium text-gray-300">4. Anexar Mídia (Opcional)</label>
                <p class="text-xs text-gray-400 mb-1">Formatos: .jpg, .ogg, .opus</p>
                <input type="file" id="mediaFile" class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white file:hover:bg-indigo-700 file:cursor-pointer" accept="image/jpeg, audio/ogg, audio/opus">
            </div>
            <button id="sendButton" onclick="enviarValores()" class="w-full btn-glass text-white font-bold py-3 px-4 rounded-md text-lg">Enviar!</button>
        </div>

        <!-- Secção do Dashboard -->
        <div class="sidebar" id="dashboard">
            <h2 class="text-2xl font-bold mb-6">Dashboard de Contatos</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="glass-container p-6"><h3 class="text-gray-300 text-sm font-medium">Total de Contatos</h3><p id="total-contacts" class="text-3xl font-bold mt-2">0</p></div>
                <div class="glass-container p-6"><h3 class="text-gray-300 text-sm font-medium">Aniversariantes Hoje</h3><p id="birthdays-today" class="text-3xl font-bold mt-2 text-yellow-400">0</p></div>
                <div class="glass-container p-6"><h3 class="text-gray-300 text-sm font-medium">Contato Mais Antigo</h3><p id="oldest-contact-date" class="text-xl font-bold mt-2">N/A</p></div>
                <div class="glass-container p-6"><h3 class="text-gray-300 text-sm font-medium">Precisa de Ajuda?</h3><a href="https://wa.me/554191798537/" target="_blank" class="text-blue-400 hover:underline mt-2 block font-bold text-lg">Fale com o Suporte</a></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 glass-container p-6"><h3 class="text-lg font-bold mb-4">Faixa Etária dos Contatos</h3><div id="age-chart" class="space-y-4"></div></div>
                <div class="glass-container p-6 flex flex-col justify-start">
                    <h3 class="text-lg font-bold mb-4">Ações e Busca</h3>
                    <div class="mb-4">
                        <label for="searchInput" class="block text-sm font-medium text-gray-300 mb-1">Buscar Contato</label>
                        <div class="flex">
                            <input type="text" id="searchInput" placeholder="Nome, CPF, telefone..." class="input-glass flex-grow rounded-l-md px-3 py-2 text-white placeholder-gray-400">
                            <button onclick="handleSearch()" class="btn-glass text-white font-bold py-2 px-4 rounded-r-md">Buscar</button>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <button onclick="showContactsInModal('default')" class="w-full btn-glass text-white font-bold py-2 px-4 rounded-md">Ver Todos os Contatos</button>
                        <button onclick="showContactsInModal('aniversariantesHoje')" class="w-full btn-glass text-white font-bold py-2 px-4 rounded-md">Aniversariantes do Dia</button>
                        <button onclick="showContactsInModal('aniversariantesMes')" class="w-full btn-glass text-white font-bold py-2 px-4 rounded-md">Aniversariantes do Mês</button>
                        <button onclick="showContactsInModal('cemMaisAntigos')" class="w-full btn-glass text-white font-bold py-2 px-4 rounded-md">100 Contatos Mais Antigos</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secção do QR Code -->
        <div class="sidebar text-center" id="whatsapp-lateral">
            <h1 class="text-2xl font-bold mb-4">Status do WhatsApp</h1>
            <p class="text-gray-400 mb-4">Aponte seu celular para ler o QR Code, caso seja solicitado.</p>
            <div class="flex justify-center"><div class="glass-container p-4 inline-block"><img src="" alt="QR Code" id="qrcode" class="rounded-lg hidden"></div></div>
            <div id="whatsapp-status" class="mt-4 font-semibold"></div>
        </div>

        <!-- Secção de Retorno/Logs -->
        <div class="sidebar" id="retorno">
            <h2 class="text-xl font-bold mb-4">Logs de Envio</h2>
            <div class="text-right text-xs text-gray-400 mb-2 pr-2">Mais recente ↑ | Mais antigo ↓</div>
            <div class="glass-container p-4 max-h-96 overflow-y-auto"><ul class="logs space-y-2"></ul></div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modalPreview" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50 hidden">
        <div class="glass-container w-full max-w-6xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-700/50">
                <h3 id="modalTitle" class="text-lg font-semibold">Visualização</h3>
                <button onclick="fecharPreview()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="p-4 overflow-auto" id="previewContent"></div>
            <div class="p-4 border-t border-gray-700/50 flex justify-end" id="modalFooter"></div>
        </div>
    </div>

    <!-- Bibliotecas JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/notify/0.4.2/notify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        let socket;
        let tabelaPreview = '';
        // Variáveis para guardar o estado atual do modal
        let lastModalFilter = 'default';
        let lastModalSearch = '';


        $(document).ready(function () {
            const token = localStorage.getItem('jwtToken');
            if (token) {
                $('#auth-container').hide();
                $('#app-container').removeClass('hidden').addClass('block');
                startApp();
            } else {
                $('#auth-container').show();
                $('#app-container').hide();
            }
        });

        function toggleAuthScreens(event) {
            event.preventDefault();
            $('#login-screen').toggleClass('hidden');
            $('#register-screen').toggleClass('hidden');
            $('#login-error, #register-error, #register-success').text('');
        }

        async function handleRegister(event) {
            event.preventDefault();
            $('#register-error').text('');
            $('#register-success').text('');
            const username = $('#register-username').val();
            const password = $('#register-password').val();
            if (!username || !password) {
                $('#register-error').text("Utilizador e senha são obrigatórios.");
                return;
            }
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const result = await response.json();
                if (response.ok) {
                    $('#register-success').text(result.message + " Você pode fazer o login agora.");
                    $('#register-form')[0].reset();
                    setTimeout(() => toggleAuthScreens(event), 2500);
                } else {
                    $('#register-error').text(result.message || 'Erro desconhecido ao registar.');
                }
            } catch (error) {
                console.error("Erro no registo:", error);
                $('#register-error').text("Erro de conexão ao tentar registar.");
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            $('#login-error').text('');
            const username = $('#login-username').val();
            const password = $('#login-password').val();
            if (!username || !password) {
                $('#login-error').text("Utilizador e senha são obrigatórios.");
                return;
            }
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const result = await response.json();
                if (response.ok) {
                    localStorage.setItem('jwtToken', result.token);
                    window.location.reload();
                } else {
                    $('#login-error').text(result.message || 'Credenciais inválidas.');
                }
            } catch (error) {
                console.error("Erro no login:", error);
                $('#login-error').text("Erro de conexão ao tentar fazer login.");
            }
        }

        function logout() {
            if (socket) socket.disconnect();
            localStorage.removeItem('jwtToken');
            location.reload();
        }

        function startApp() {
            socket = io({ auth: { token: localStorage.getItem('jwtToken') } });
            setupSocketListeners();
            $('.menu-link').on('click', function (e) {
                e.preventDefault();
                switchView($(this).attr('href'));
            });
            switchView('#dashboard');
        }

        function setupSocketListeners() {
            socket.on('connect_error', (err) => {
                if (err.message === "Token inválido.") handleAuthError();
            });
            socket.on('qr', function (url) {
                switchView('#whatsapp-lateral');
                $('#qrcode').attr('src', url).show();
                $('#whatsapp-status').text('Por favor, escaneie o QR Code.').removeClass('text-green-400 text-red-400');
            });
            socket.on('ready', function () {
                $('#qrcode').hide();
                $('#whatsapp-status').text('WhatsApp conectado com sucesso!').removeClass('text-red-400').addClass('text-green-400');
                loadDashboardData();
                setTimeout(() => switchView('#dashboard'), 2000);
            });
            socket.on('disconnected', function () {
                $('#whatsapp-status').text('WhatsApp desconectado.').removeClass('text-green-400').addClass('text-red-400');
                $.notify("WhatsApp foi desconectado.", { className: "error", position: "top center" });
            });
            socket.on('log', function (msg) {
                let statusClass = 'log-error';
                if (msg.includes('✅') || msg.includes('Sucesso') || msg.includes('🏁')) statusClass = 'log-success';
                else if (msg.includes('🟡') || msg.includes('Atenção') || msg.includes('▶️')) statusClass = 'log-warn';
                $('.logs').prepend(`<li class="${statusClass} p-2 rounded-md text-sm">${msg}</li>`);
            });
            socket.on('upload-success', (data) => console.log('Upload bem-sucedido:', data.fileName));
            socket.on('campaign-finished', () => {
                $('#sendButton').prop('disabled', false).text('Enviar!');
                $.notify("Campanha finalizada!", { className: "success", position: "top center" });
            });
        }

        function handleAuthError() {
            $.notify("Sessão expirada. Faça login novamente.", { className: "error", position: "top center" });
            setTimeout(logout, 2000);
        }

        function parseJwt(token) {
            try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
        }

        async function enviarValores() {
            const planilhaInput = $('#planilha')[0];
            const valor1 = $('#valor1').val();
            const valor2 = $('#valor2').val();
            const mensagem = $('#mensagem').val();
            const mediaInput = $('#mediaFile')[0];

            if (!planilhaInput.files[0]) return $.notify("Selecione uma planilha.", { className: "error", position: "top center" });
            if (!valor1 || !valor2 || parseInt(valor1) < 1 || parseInt(valor2) < parseInt(valor1)) return $.notify("Verifique os valores de início e final.", { className: "error", position: "top center" });
            if (!socket) return $.notify("Conexão não estabelecida.", { className: "error", position: "top center" });

            $('#sendButton').prop('disabled', true).text('A preparar...');
            switchView('#retorno');

            try {
                const token = localStorage.getItem('jwtToken');
                const userData = parseJwt(token);
                if (!userData || !userData.clientId) throw new Error("Conecte o WhatsApp primeiro.");
                const clientId = userData.clientId;
                const listFile = planilhaInput.files[0];
                const fileBuffer = await listFile.arrayBuffer();
                socket.emit('upload-list', { id: clientId, file: fileBuffer, fileName: listFile.name });
                $.notify("A enviar a lista...", { className: "warn", position: "top center" });

                if (mediaInput.files[0]) {
                    const mediaFile = mediaInput.files[0];
                    const mediaBuffer = await mediaFile.arrayBuffer();
                    socket.emit('upload-media', { id: clientId, file: mediaBuffer, type: mediaFile.type });
                    $.notify("A enviar a multimédia...", { className: "warn", position: "top center" });
                }
                const campaignData = { id: clientId, username: userData.username, start: parseInt(valor1), end: parseInt(valor2), message: mensagem, listFileName: listFile.name };
                setTimeout(() => {
                    $('#sendButton').text('A enviar mensagens...');
                    socket.emit('start-sending', campaignData);
                }, 1500);
            } catch (error) {
                console.error("Erro ao preparar campanha:", error);
                $.notify(error.message, { className: "error", position: "top center" });
                $('#sendButton').prop('disabled', false).text('Enviar!');
            }
        }

        function calculateAge(dateString) {
            if (!dateString || typeof dateString !== 'string') return null;
            const parts = dateString.split(/[/.-]/);
            if (parts.length !== 3) return null;
            
            let month = parseInt(parts[0], 10);
            let day = parseInt(parts[1], 10);
            let year = parseInt(parts[2], 10);

            if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
            if (year < 100) year += (year < 30) ? 2000 : 1900;
            
            const birthDate = new Date(Date.UTC(year, month - 1, day));
            if (birthDate.getUTCFullYear() !== year || birthDate.getUTCMonth() + 1 !== month || birthDate.getUTCDate() !== day) return null;
            
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
            return age >= 0 ? age : null;
        }

        async function loadDashboardData() {
            try {
                const token = localStorage.getItem('jwtToken');
                const response = await fetch(`/api/contacts?filter=default&search=`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.status === 401 || response.status === 403) return handleAuthError();
                const data = await response.json();
                if (data.error) {
                    console.warn(data.error);
                    $.notify(data.error, { className: "warn", position: "top center" });
                    $('#total-contacts, #birthdays-today').text(0);
                    $('#oldest-contact-date').text('N/A');
                    renderAgeChart({}, 0);
                    return;
                }
                const contacts = data.contacts || data;
                if (!Array.isArray(contacts)) throw new Error('Resposta inesperada do servidor.');
                $('#total-contacts').text(contacts.length);
                const today = new Date(), currentMonth = today.getMonth() + 1, currentDay = today.getDate();
                
                const birthdaysToday = contacts.filter(c => {
                    if (!c.nascimento) return false;
                    const parts = c.nascimento.split(/[/.-]/);
                    if (parts.length !== 3) return false;
                    return parseInt(parts[0], 10) === currentMonth && parseInt(parts[1], 10) === currentDay;
                });
                $('#birthdays-today').text(birthdaysToday.length);

                let oldestContactDate = 'N/A';
                if (contacts.length > 0) {
                    const sortedContacts = [...contacts].filter(c => c.data_envio_ultima_mensagem).sort((a, b) => new Date(a.data_envio_ultima_mensagem) - new Date(b.data_envio_ultima_mensagem));
                    if (sortedContacts.length > 0) oldestContactDate = new Date(sortedContacts[0].data_envio_ultima_mensagem).toLocaleDateString('pt-BR');
                }
                $('#oldest-contact-date').text(oldestContactDate);
                const ageGroups = { '0-18': 0, '19-30': 0, '31-45': 0, '46-60': 0, '60+': 0, 'N/A': 0 };
                contacts.forEach(c => {
                    const age = calculateAge(c.nascimento);
                    if (age === null) ageGroups['N/A']++;
                    else if (age <= 18) ageGroups['0-18']++;
                    else if (age <= 30) ageGroups['19-30']++;
                    else if (age <= 45) ageGroups['31-45']++;
                    else if (age <= 60) ageGroups['46-60']++;
                    else ageGroups['60+']++;
                });
                renderAgeChart(ageGroups, contacts.length);
            } catch (error) {
                console.error("Erro ao carregar dados do dashboard:", error);
                $.notify('Erro ao carregar dados do dashboard.', { className: "error", position: "top center" });
            }
        }

        function renderAgeChart(ageGroups, total) {
            const chartContainer = $('#age-chart');
            chartContainer.empty();
            if (total === 0) {
                chartContainer.html('<p class="text-gray-400">Sem dados de idade para exibir.</p>');
                return;
            }
            const maxCount = Math.max(...Object.values(ageGroups));
            const colors = { '0-18': 'bg-teal-500', '19-30': 'bg-sky-500', '31-45': 'bg-indigo-500', '46-60': 'bg-purple-500', '60+': 'bg-pink-500', 'N/A': 'bg-gray-500' };
            for (const group in ageGroups) {
                const count = ageGroups[group];
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                const barWidth = maxCount > 0 ? (count / maxCount) * 100 : 0;
                const barHtml = `<div class="flex items-center"><div class="w-16 text-sm text-gray-300">${group}</div><div class="flex-1 bg-white/10 rounded-full h-6 mr-2"><div class="${colors[group]} h-6 rounded-full" style="width: ${barWidth}%"></div></div><div class="w-20 text-right text-sm font-semibold">${count} (${percentage}%)</div></div>`;
                chartContainer.append(barHtml);
            }
        }

        function handleSearch() {
            const searchTerm = $('#searchInput').val();
            showContactsInModal('default', searchTerm);
        }

        async function showContactsInModal(filtro = 'default', termoBusca = '') {
            lastModalFilter = filtro;
            lastModalSearch = termoBusca;
            try {
                const token = localStorage.getItem('jwtToken');
                const response = await fetch(`/api/contacts?filter=${filtro}&search=${encodeURIComponent(termoBusca)}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.status === 401 || response.status === 403) return handleAuthError();
                const data = await response.json();
                if (data.error) {
                    $('#previewContent').html(`<p class="text-center text-gray-400 p-8">${data.error}</p>`);
                    $('#modalFooter').html('');
                    $('#modalPreview').removeClass('hidden').addClass('flex');
                    return;
                }
                const contacts = data.contacts || data;
                let tabelaHtml = renderizarTabelaModal(contacts);
                let footerHtml = '';
                let modalTitle = 'Resultados da Busca';
                if (filtro === 'aniversariantesHoje') modalTitle = "Aniversariantes do Dia";
                else if (filtro === 'aniversariantesMes') modalTitle = "Aniversariantes do Mês";
                else if (filtro === 'cemMaisAntigos') modalTitle = "100 Contatos Mais Antigos";
                else if (filtro === 'default' && !termoBusca) modalTitle = "Todos os Contatos";
                if (['aniversariantesHoje', 'aniversariantesMes', 'cemMaisAntigos', 'default'].includes(filtro) && contacts.length > 0) {
                    footerHtml = `<button onclick='criarListaCsv(${JSON.stringify(contacts)}, "${filtro}")' class="btn-glass text-white font-bold py-2 px-4 rounded">Criar Lista CSV</button>`;
                }
                $('#modalTitle').text(modalTitle);
                $('#previewContent').html(tabelaHtml);
                $('#modalFooter').html(footerHtml);
                $('#modalPreview').removeClass('hidden').addClass('flex');
            } catch (error) {
                console.error("Erro ao carregar contatos para o modal:", error);
                $.notify('Erro ao carregar dados do banco.', { className: "error", position: "top center" });
            }
        }

        function switchView(targetId) {
            $('.sidebar').hide();
            $(targetId).show();
            $('.menu-link').removeClass('bg-white/20');
            $(`.menu-link[href="${targetId}"]`).addClass('bg-white/20');
            if (targetId === '#dashboard') loadDashboardData();
        }

        function abrirPreview() {
            if (tabelaPreview) {
                $('#modalTitle').text('Pré-visualização da Lista');
                $('#previewContent').html(tabelaPreview);
                $('#modalFooter').html('');
                $('#modalPreview').removeClass('hidden').addClass('flex');
            } else {
                return $.notify('Nenhuma planilha carregada para pré-visualizar!', { className: "warn", position: "top center" });
            }
        }

        function fecharPreview() {
            $('#modalPreview').removeClass('flex').addClass('hidden');
            $('#previewContent').empty();
            $('#modalFooter').empty();
        }

        function previewPlanilha(event) {
            const file = event.target.files[0];
            if (!file) { tabelaPreview = ''; return; }
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, defval: "" });
                    if (!json || json.length <= 1) {
                        tabelaPreview = '<p class="text-center text-gray-400">A planilha está vazia.</p>';
                        return;
                    }
                    const maxCols = json.reduce((max, row) => Math.max(max, row.length), 0);
                    let table = '<div class="overflow-x-auto"><table class="contacts-table w-full text-sm"><thead><tr>';
                    table += '<th class="p-2 sticky top-0 bg-gray-700 text-center">Índice</th>';
                    if (json.length > 0) {
                        for (let colIndex = 0; colIndex < maxCols; colIndex++) {
                            table += `<th class="p-2 sticky top-0 bg-gray-700">${json[0][colIndex] || ''}</th>`;
                        }
                    }
                    table += '</tr></thead><tbody>';
                    for (let rowIndex = 1; rowIndex < json.length; rowIndex++) {
                        const rowData = json[rowIndex];
                        if (!rowData.some(cell => cell && String(cell).trim() !== '')) continue;
                        table += '<tr>';
                        table += `<td class="p-2 text-center font-semibold bg-gray-800">${rowIndex + 1}</td>`;
                        for (let colIndex = 0; colIndex < maxCols; colIndex++) {
                            table += `<td class="p-2">${String(rowData[colIndex] || '').trim()}</td>`;
                        }
                        table += '</tr>';
                    }
                    table += '</tbody></table></div>';
                    tabelaPreview = table;
                    $.notify("Pré-visualização pronta.", { className: "success", position: "top center" });
                } catch (error) {
                    console.error("Erro ao ler a planilha:", error);
                    $.notify("Arquivo inválido ou corrompido.", { className: "error", position: "top center" });
                    tabelaPreview = '';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function renderizarTabelaModal(dados) {
            if (!dados || dados.length === 0) return '<p class="text-center text-gray-400 p-8">Nenhum contato encontrado.</p>';
            let tabela = '<div class="overflow-x-auto"><table class="contacts-table w-full text-sm"><thead><tr><th>Nome</th><th>CPF</th><th>Agência</th><th>Nascimento</th><th>Idade</th><th>Telefone</th><th>Último Envio</th><th>Ações</th></tr></thead><tbody>';
            dados.forEach(contato => {
                const numeroTelefone = contato.telefone || '';
                let telefoneHtml = numeroTelefone ? `<a href="https://wa.me/${numeroTelefone}" target="_blank" class="text-blue-400 hover:underline" title="Abrir conversa">${numeroTelefone}</a>` : '';
                const idade = calculateAge(contato.nascimento);
                
                let dataNascimentoFormatada = '';
                if (contato.nascimento) {
                    const parts = contato.nascimento.split(/[/.-]/);
                    if (parts.length === 3) {
                        let month = parts[0];
                        let day = parts[1];
                        let year = parseInt(parts[2], 10);
                        if (!isNaN(year)) {
                            if (year < 100) year += (year < 30) ? 2000 : 1900;
                            dataNascimentoFormatada = `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
                        } else {
                            dataNascimentoFormatada = contato.nascimento;
                        }
                    } else {
                        dataNascimentoFormatada = contato.nascimento;
                    }
                }
                
                const dataEnvio = contato.data_envio_ultima_mensagem ? new Date(contato.data_envio_ultima_mensagem).toLocaleDateString('pt-BR') : '';
                tabela += `<tr>
                                <td>${contato.nome || ''}</td>
                                <td>${contato.cpf || ''}</td>
                                <td>${contato.agencia || ''}</td>
                                <td>${dataNascimentoFormatada}</td>
                                <td>${idade !== null ? idade : 'N/A'}</td>
                                <td>${telefoneHtml}</td>
                                <td>${dataEnvio}</td>
                                <td class="p-2 space-x-2 whitespace-nowrap">
                                    <button onclick="editContact(${contato.id}, '${String(contato.nome || '').replace(/'/g, "\\'")}')" class="text-yellow-400 hover:text-yellow-300 font-semibold">Editar</button>
                                    <button onclick="deleteContact(${contato.id})" class="text-red-500 hover:text-red-400 font-semibold">Apagar</button>
                                </td>
                            </tr>`;
            });
            tabela += '</tbody></table></div>';
            return tabela;
        }

        async function editContact(contactId, currentName) {
            const newName = prompt("Digite o novo nome para o contato:", currentName);
            if (newName && newName.trim() !== '' && newName !== currentName) {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch(`/api/contacts/${contactId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ nome: newName })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        $.notify(result.message, { className: "success", position: "top center" });
                        showContactsInModal(lastModalFilter, lastModalSearch); // Atualiza a tabela
                        loadDashboardData(); // Atualiza o dashboard
                    } else {
                        throw new Error(result.message || 'Falha ao atualizar contato.');
                    }
                } catch (error) {
                    console.error("Erro ao editar contato:", error);
                    $.notify(error.message, { className: "error", position: "top center" });
                }
            }
        }

        async function deleteContact(contactId) {
            if (confirm("Tem certeza que deseja apagar este contato? Esta ação não pode ser desfeita.")) {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch(`/api/contacts/${contactId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (response.ok) {
                        $.notify(result.message, { className: "success", position: "top center" });
                        showContactsInModal(lastModalFilter, lastModalSearch); // Atualiza a tabela
                        loadDashboardData(); // Atualiza o dashboard
                    } else {
                        throw new Error(result.message || 'Falha ao apagar contato.');
                    }
                } catch (error) {
                    console.error("Erro ao apagar contato:", error);
                    $.notify(error.message, { className: "error", position: "top center" });
                }
            }
        }

        function criarListaCsv(dados, filtro) {
            if (!dados || !dados.length) return $.notify("Nenhum dado para exportar.", { className: "warn", position: "top center" });
            const headers = ["nome", "cpf", "agencia", "nascimento", "DDD", "Telefone", "data_envio_ultima_mensagem"];
            let csv = headers.join(";") + "\n";
            dados.forEach(item => {
                const telefone = (item.telefone || "").toString();
                const ddd = telefone.slice(2, 4);
                const tel = telefone.slice(4);
                const linha = [`"${(item.nome || "").replace(/"/g, '""')}"`, `"${(item.cpf || "").replace(/"/g, '""')}"`, `"${(item.agencia || "").replace(/"/g, '""')}"`, `"${(item.nascimento || "").replace(/"/g, '""')}"`, `"${ddd}"`, `"${tel}"`, `"${(item.data_envio_ultima_mensagem || "").replace(/"/g, '""')}"`];
                csv += linha.join(";") + "\n";
            });
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${filtro}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>

</html>
