<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Whatsapp Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2071&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .glass-container {
            background: rgba(28, 37, 54, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .btn-glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-glass:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .input-glass {
            background-color: rgba(0, 0, 0, 0.2) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }
        .log-success { background-color: rgba(46, 125, 50, 0.8); color: #fff; }
        .log-error { background-color: rgba(198, 40, 40, 0.8); color: #fff; }
        .log-warn { background-color: rgba(249, 168, 37, 0.8); color: #000; }
        .contacts-table { border-collapse: collapse; width: 100%; }
        .contacts-table th, .contacts-table td {
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px;
            text-align: left;
            background-color: rgba(45, 55, 72, 0.8);
            color: #e2e8f0;
        }
        .contacts-table th {
            background-color: rgba(26, 32, 44, 0.9);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="auth-container" class="w-full max-w-sm">
        <div id="login-screen">
            <form id="login-form" onsubmit="handleLogin(event)"
                class="glass-container p-6 md:p-8 space-y-6">
                <h1 class="text-2xl font-bold text-center text-white">Login</h1>
                <p class="text-center text-gray-300 text-sm">Faça login para continuar</p>
                <div>
                    <label for="login-username" class="block text-sm font-medium text-gray-300">Utilizador</label>
                    <input type="text" id="login-username" placeholder="Seu utilizador" required
                        class="input-glass mt-1 w-full rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-300">Senha</label>
                    <input type="password" id="login-password" placeholder="Sua senha" required
                        class="input-glass mt-1 w-full rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="login-error" class="text-red-400 text-sm text-center h-4"></div>
                <button type="submit"
                    class="w-full btn-glass text-white font-bold py-2 px-4 rounded-md">Entrar</button>
                <p class="text-center text-sm text-gray-300 pt-2">
                    Não tem uma conta? <a href="#" onclick="toggleAuthScreens(event)"
                        class="font-semibold text-blue-400 hover:underline">Registe-se</a>
                </p>
            </form>
        </div>
        <div id="register-screen" class="hidden">
            <form id="register-form" onsubmit="handleRegister(event)"
                class="glass-container p-6 md:p-8 space-y-6">
                <h1 class="text-2xl font-bold text-center text-white">Registar</h1>
                <p class="text-center text-gray-300 text-sm">Crie uma nova conta</p>
                <div>
                    <label for="register-username" class="block text-sm font-medium text-gray-300">Utilizador</label>
                    <input type="text" id="register-username" placeholder="Escolha um utilizador" required
                        class="input-glass mt-1 w-full rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-300">Senha</label>
                    <input type="password" id="register-password" placeholder="Crie uma senha" required
                        class="input-glass mt-1 w-full rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="register-error" class="text-red-400 text-sm text-center h-4"></div>
                <div id="register-success" class="text-green-400 text-sm text-center h-4"></div>
                <button type="submit"
                    class="w-full btn-glass text-white font-bold py-2 px-4 rounded-md">Criar Conta</button>
                <p class="text-center text-sm text-gray-300 pt-2">
                    Já tem uma conta? <a href="#" onclick="toggleAuthScreens(event)"
                        class="font-semibold text-blue-400 hover:underline">Faça Login</a>
                </p>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden w-full max-w-6xl glass-container p-6 md:p-8">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold">Whatsapp Assistant</h1>
            <button onclick="logout()"
                class="btn-glass text-white font-bold py-2 px-4 rounded-md text-sm">Sair</button>
        </div>

        <div class="flex justify-around mb-6 border-b border-gray-700/50 pb-4">
            <a href="#dashboard" class="menu-link px-4 py-2 rounded-md hover:bg-white/10 transition-colors duration-200">Dashboard</a>
            <a href="#disparo" class="menu-link px-4 py-2 rounded-md hover:bg-white/10 transition-colors duration-200">Disparo</a>
            <a href="#admin" class="menu-link px-4 py-2 rounded-md hover:bg-white/10 transition-colors duration-200">Administrador</a>
            <a href="#retorno" class="menu-link px-4 py-2 rounded-md hover:bg-white/10 transition-colors duration-200">Logs</a>
            <a href="#whatsapp-lateral" class="menu-link px-4 py-2 rounded-md hover:bg-white/10 transition-colors duration-200">WhatsApp</a>
        </div>

        <div class="sidebar space-y-4" id="disparo">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">1. Escolha uma lista (.csv, .xlsx)</label>
                <input type="file" id="planilha" class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white file:hover:bg-indigo-700 file:cursor-pointer" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" onchange="previewPlanilha(event)">
                <button onclick="abrirPreview()" class="mt-2 w-full btn-glass text-white font-bold py-2 px-4 rounded-md">Pré-visualizar Lista</button>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">2. Digite o índice dos clientes:</label>
                <div class="flex space-x-2">
                    <input type="number" placeholder="Início" id="valor1" min="1" class="input-glass w-1/2 rounded-md px-3 py-2 text-white placeholder-gray-400">
                    <input type="number" placeholder="Final" id="valor2" min="1" class="input-glass w-1/2 rounded-md px-3 py-2 text-white placeholder-gray-400">
                </div>
            </div>
            <div>
                <label for="mensagem" class="block text-sm font-medium text-gray-300">3. Mensagem</label>
                <p class="text-xs text-gray-400 mb-1">Use: @nome @nomecompleto @cpf @agencia</p>
                <textarea id="mensagem" placeholder="Digite seu texto aqui." rows="5" class="input-glass w-full rounded-md px-3 py-2 text-white placeholder-gray-400"></textarea>
            </div>
            <div>
                <label for="mediaFile" class="block text-sm font-medium text-gray-300">4. Anexar Mídia (Opcional)</label>
                <p class="text-xs text-gray-400 mb-1">Formatos: .jpg, .ogg, .opus</p>
                <input type="file" id="mediaFile" class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white file:hover:bg-indigo-700 file:cursor-pointer" accept="image/jpeg, audio/ogg, audio/opus">
            </div>
            <button id="sendButton" onclick="enviarValores()" class="w-full btn-glass text-white font-bold py-3 px-4 rounded-md text-lg">Enviar!</button>
        </div>

        <div class="sidebar" id="dashboard">
            <h2 class="text-2xl font-bold mb-6">Dashboard de Contatos</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="glass-container p-6"><h3 class="text-gray-300 text-sm font-medium">Total de Contatos</h3><p id="total-contacts" class="text-3xl font-bold mt-2">0</p></div>
                <div class="glass-container p-6"><h3 class="text-gray-300 text-sm font-medium">Aniversariantes Hoje</h3><p id="birthdays-today" class="text-3xl font-bold mt-2 text-yellow-400">0</p></div>
                <div class="glass-container p-6"><h3 class="text-gray-300 text-sm font-medium">Contato Mais Antigo</h3><p id="oldest-contact-date" class="text-xl font-bold mt-2">N/A</p></div>
                <div class="glass-container p-6"><h3 class="text-gray-300 text-sm font-medium">Precisa de Ajuda?</h3><a href="https://wa.me/554191798537/" target="_blank" class="text-blue-400 hover:underline mt-2 block font-bold text-lg">Fale com o Suporte</a></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 glass-container p-6"><h3 class="text-lg font-bold mb-4">Faixa Etária dos Contatos</h3><div id="age-chart" class="space-y-4"></div></div>
                <div class="glass-container p-6 flex flex-col justify-start">
                    <h3 class="text-lg font-bold mb-4">Ações e Busca</h3>
                    <div class="mb-4">
                        <label for="searchInput" class="block text-sm font-medium text-gray-300 mb-1">Buscar Contato</label>
                        <div class="flex">
                            <input type="text" id="searchInput" placeholder="Nome, CPF, telefone..." class="input-glass flex-grow rounded-l-md px-3 py-2 text-white placeholder-gray-400">
                            <button onclick="handleSearch()" class="btn-glass text-white font-bold py-2 px-4 rounded-r-md">Buscar</button>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <button onclick="showContactsInModal('default')" class="w-full btn-glass text-white font-bold py-2 px-4 rounded-md">Ver Todos os Contatos</button>
                        <button onclick="showContactsInModal('aniversariantesHoje')" class="w-full btn-glass text-white font-bold py-2 px-4 rounded-md">Aniversariantes do Dia</button>
                        <button onclick="showContactsInModal('aniversariantesMes')" class="w-full btn-glass text-white font-bold py-2 px-4 rounded-md">Aniversariantes do Mês</button>
                        <button onclick="showContactsInModal('cemMaisAntigos')" class="w-full btn-glass text-white font-bold py-2 px-4 rounded-md">100 Contatos Mais Antigos</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="sidebar" id="admin">
            <h2 class="text-2xl font-bold mb-4">Painel do Administrador</h2>
            <p class="text-gray-400 mb-6">Analise os dados das suas listas importadas e extraia insights para as suas campanhas.</p>
            
            <div class="glass-container p-4 mb-6">
                <label for="admin-sheet-select" class="block text-sm font-medium text-gray-300 mb-2">Selecione uma lista para analisar:</label>
                <select id="admin-sheet-select" class="input-glass w-full rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">-- Carregando listas... --</option>
                </select>
            </div>

            <div id="admin-dashboard-content" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="glass-container p-6"><h3 class="text-lg font-bold mb-4">Distribuição por Idade</h3><div class="chart-container"><canvas id="admin-age-chart"></canvas></div></div>
                    <div class="glass-container p-6"><h3 class="text-lg font-bold mb-4">Distribuição por Agência</h3><div class="chart-container"><canvas id="admin-agency-chart"></canvas></div></div>
                    <div class="glass-container p-6"><h3 class="text-lg font-bold mb-4">Distribuição por DDD</h3><div class="chart-container"><canvas id="admin-ddd-chart"></canvas></div></div>
                </div>
                <div class="glass-container p-6">
                    <h3 class="text-lg font-bold mb-4">Baixar Lista de Contatos</h3>
                    <div class="flex items-center gap-4">
                        <input type="number" id="download-rows-input" placeholder="Nº de linhas" class="input-glass rounded-md px-3 py-2 text-white placeholder-gray-400 w-40">
                        <button id="download-csv-btn" class="btn-glass text-white font-bold py-2 px-4 rounded-md flex-1">Baixar CSV</button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Deixe em branco para baixar a lista completa.</p>
                </div>
            </div>
             <div id="admin-no-data" class="text-center py-10 text-gray-400">
                <p>Nenhuma lista selecionada ou as listas importadas estão vazias.</p>
            </div>
        </div>

        <div class="sidebar text-center" id="whatsapp-lateral">
            <h1 class="text-2xl font-bold mb-4">Status do WhatsApp</h1>
            <p class="text-gray-400 mb-4">Aponte seu celular para ler o QR Code, caso seja solicitado.</p>
            <div class="flex justify-center"><div class="glass-container p-4 inline-block"><img src="" alt="QR Code" id="qrcode" class="rounded-lg hidden"></div></div>
            <div id="whatsapp-status" class="mt-4 font-semibold"></div>
        </div>

        <div class="sidebar" id="retorno">
            <h2 class="text-xl font-bold mb-4">Logs de Envio</h2>
            <div class="text-right text-xs text-gray-400 mb-2 pr-2">Mais recente ↑ | Mais antigo ↓</div>
            <div class="glass-container p-4 max-h-96 overflow-y-auto"><ul class="logs space-y-2"></ul></div>
        </div>
    </div>

    <div id="modalPreview" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50 hidden">
        <div class="glass-container w-full max-w-6xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-700/50">
                <h3 id="modalTitle" class="text-lg font-semibold">Visualização</h3>
                <button onclick="fecharPreview()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="p-4 overflow-auto" id="previewContent"></div>
            <div class="p-4 border-t border-gray-700/50 flex justify-end" id="modalFooter"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/notify/0.4.2/notify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        let socket;
        let tabelaPreview = '';
        let lastModalFilter = 'default';
        let lastModalSearch = '';

        let adminCharts = {};
        let currentAdminData = [];

        $(document).ready(function () {
            const token = localStorage.getItem('jwtToken');
            if (token) {
                $('#auth-container').hide();
                $('#app-container').removeClass('hidden').addClass('block');
                startApp();
            } else {
                $('#auth-container').show();
                $('#app-container').hide();
            }
        });

        function toggleAuthScreens(event) {
            event.preventDefault();
            $('#login-screen').toggleClass('hidden');
            $('#register-screen').toggleClass('hidden');
            $('#login-error, #register-error, #register-success').text('');
        }

        async function handleRegister(event) {
            event.preventDefault();
            const username = $('#register-username').val();
            const password = $('#register-password').val();
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                $('#register-success').text(result.message + " Faça o login.");
                setTimeout(() => toggleAuthScreens(event), 2000);
            } catch (error) {
                $('#register-error').text(error.message);
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = $('#login-username').val();
            const password = $('#login-password').val();
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                localStorage.setItem('jwtToken', result.token);
                window.location.reload();
            } catch (error) {
                $('#login-error').text(error.message);
            }
        }

        function logout() {
            if (socket) socket.disconnect();
            localStorage.removeItem('jwtToken');
            location.reload();
        }

        function startApp() {
            socket = io({ auth: { token: localStorage.getItem('jwtToken') } });
            setupSocketListeners();
            $('.menu-link').on('click', function (e) {
                e.preventDefault();
                switchView($(this).attr('href'));
            });
            switchView('#dashboard');
        }

        function setupSocketListeners() {
            socket.on('connect_error', (err) => { if (err.message === "Token inválido.") handleAuthError(); });
            socket.on('qr', url => {
                switchView('#whatsapp-lateral');
                $('#qrcode').attr('src', url).show();
                $('#whatsapp-status').text('Por favor, escaneie o QR Code.');
            });
            socket.on('ready', () => {
                $('#qrcode').hide();
                $('#whatsapp-status').text('WhatsApp conectado!').addClass('text-green-400');
                loadDashboardData();
                setTimeout(() => switchView('#dashboard'), 1500);
            });
            socket.on('disconnected', () => {
                $('#whatsapp-status').text('WhatsApp desconectado.').removeClass('text-green-400').addClass('text-red-400');
            });
            socket.on('log', msg => $('.logs').prepend(`<li class="p-2 rounded-md text-sm">${msg}</li>`));
            socket.on('campaign-finished', () => {
                $('#sendButton').prop('disabled', false).text('Enviar!');
            });
        }

        function handleAuthError() {
            $.notify("Sessão expirada.", "error");
            setTimeout(logout, 1500);
        }

        function parseJwt(token) {
            try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
        }

        async function enviarValores() {
            const planilhaInput = $('#planilha')[0];
            const valor1 = $('#valor1').val() - 1;
            const valor2 = $('#valor2').val() - 1;
            const mensagem = $('#mensagem').val();
            const mediaInput = $('#mediaFile')[0];

            if (!planilhaInput.files[0] || !valor1 || !valor2) return $.notify("Preencha todos os campos obrigatórios.", "error");
            
            $('#sendButton').prop('disabled', true).text('A preparar...');
            switchView('#retorno');

            try {
                const token = localStorage.getItem('jwtToken');
                const userData = parseJwt(token);
                if (!userData || !userData.clientId) throw new Error("Conecte o WhatsApp.");
                
                const listFile = planilhaInput.files[0];
                const fileBuffer = await listFile.arrayBuffer();
                socket.emit('upload-list', { id: userData.clientId, file: fileBuffer, fileName: listFile.name });

                if (mediaInput.files[0]) {
                    const mediaFile = mediaInput.files[0];
                    const mediaBuffer = await mediaFile.arrayBuffer();
                    socket.emit('upload-media', { id: userData.clientId, file: mediaBuffer, type: mediaFile.type });
                }
                
                setTimeout(() => {
                    $('#sendButton').text('A enviar...');
                    socket.emit('start-sending', { 
                        id: userData.clientId, 
                        username: userData.username, 
                        start: parseInt(valor1), 
                        end: parseInt(valor2), 
                        message: mensagem, 
                        listFileName: listFile.name 
                    });
                }, 1500);
            } catch (error) {
                $.notify(error.message, "error");
                $('#sendButton').prop('disabled', false).text('Enviar!');
            }
        }

        // Função de formatação de data para exibição no frontend (nova ou aprimorada)
        function formatarDataParaExibicao(data) {
            if (!data) return '';
            let date;

            if (typeof data === 'string') {
                const parts = data.split(/[\/\-\.]/); // Divide por '/', '-' ou '.'
                if (parts.length === 3) {
                    let p1 = parseInt(parts[0], 10); // Dia ou Mês
                    let p2 = parseInt(parts[1], 10); // Mês ou Dia
                    let p3 = parseInt(parts[2], 10); // Ano

                    let tempDate = new Date(p3, p2 - 1, p1); // Tenta MM/DD/YYYY ou DD/MM/YYYY (dependendo do input)

                    if (String(p3).length === 2) { // Se o ano tiver 2 dígitos, tenta inferir o século
                        let fullYear = p3;
                        if (fullYear < 30) { // Ex: 00-29 -> 2000-2029
                            fullYear += 2000;
                        } else { // Ex: 30-99 -> 1930-1999
                            fullYear += 1900;
                        }
                        // Tenta DD/MM/YY primeiro
                        tempDate = new Date(fullYear, p2 - 1, p1);
                        if (tempDate.getMonth() + 1 === p2 && tempDate.getDate() === p1) { // Verifica se a data é válida no formato DD/MM/YY
                            date = tempDate;
                        } else { // Se não, tenta MM/DD/YY
                            tempDate = new Date(fullYear, p1 - 1, p2);
                            if (tempDate.getMonth() + 1 === p1 && tempDate.getDate() === p2) { // Verifica se a data é válida no formato MM/DD/YY
                                date = tempDate;
                            }
                        }
                    } else if (String(p3).length === 4) { // Ano já tem 4 dígitos
                        // Tenta DD/MM/YYYY primeiro
                        tempDate = new Date(p3, p2 - 1, p1);
                        if (tempDate.getMonth() + 1 === p2 && tempDate.getDate() === p1) { // Verifica se a data é válida no formato DD/MM/YYYY
                            date = tempDate;
                        } else { // Se não, tenta MM/DD/YYYY
                            tempDate = new Date(p3, p1 - 1, p2);
                            if (tempDate.getMonth() + 1 === p1 && tempDate.getDate() === p2) { // Verifica se a data é válida no formato MM/DD/YYYY
                                date = tempDate;
                            }
                        }
                    }
                }
            }

            if (date && !isNaN(date.getTime())) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }
            return data || ''; // Retorna o original se não conseguir formatar, ou string vazia
        }


        function calculateAge(dateString) {
            // Usa a nova função de formatação para garantir que a data esteja no formato correto para cálculo
            const formattedDateString = formatarDataParaExibicao(dateString);
            if (!formattedDateString || typeof formattedDateString !== 'string') return null;

            const parts = formattedDateString.split(/[/.-]/);
            if (parts.length !== 3) return null;

            // Assume DD/MM/YYYY após a formatação
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const year = parseInt(parts[2], 10);


            if (isNaN(day) || isNaN(month) || isNaN(year)) return null;

            const birthDate = new Date(year, month - 1, day);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
            return age >= 0 ? age : null;
        }

        async function loadDashboardData() {
            try {
                const token = localStorage.getItem('jwtToken');
                const response = await fetch(`/api/contacts?filter=default&search=`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.status >= 400) return handleAuthError();
                const contacts = await response.json();
                if (!Array.isArray(contacts)) return;
                
                $('#total-contacts').text(contacts.length);
                const today = new Date();
                const birthdaysToday = contacts.filter(c => {
                    // Formata a data antes de comparar
                    const formattedNascimento = formatarDataParaExibicao(c.nascimento);
                    if (!formattedNascimento) return false;

                    const parts = formattedNascimento.split(/[/.-]/);
                    if (parts.length < 2) return false;
                    return parseInt(parts[0]) === today.getDate() && parseInt(parts[1]) === (today.getMonth() + 1);
                }).length;
                $('#birthdays-today').text(birthdaysToday);

                const oldestContact = contacts.filter(c => c.data_envio_ultima_mensagem).sort((a, b) => new Date(a.data_envio_ultima_mensagem) - new Date(b.data_envio_ultima_mensagem))[0];
                $('#oldest-contact-date').text(oldestContact ? new Date(oldestContact.data_envio_ultima_mensagem).toLocaleDateString('pt-BR') : 'N/A');

                const ageGroups = { '0-18': 0, '19-30': 0, '31-45': 0, '46-60': 0, '60+': 0, 'N/A': 0 };
                contacts.forEach(c => {
                    const age = calculateAge(c.nascimento);
                    if (age === null) ageGroups['N/A']++;
                    else if (age <= 18) ageGroups['0-18']++;
                    else if (age <= 30) ageGroups['19-30']++;
                    else if (age <= 45) ageGroups['31-45']++;
                    else if (age <= 60) ageGroups['46-60']++;
                    else ageGroups['60+']++;
                });
                renderAgeChart(ageGroups, contacts.length);
            } catch (error) {
                console.error("Erro no dashboard:", error);
            }
        }

        function renderAgeChart(ageGroups, total) {
            const chartContainer = $('#age-chart');
            chartContainer.empty();
            if (total === 0) {
                chartContainer.html('<p class="text-gray-400">Sem dados de idade.</p>');
                return;
            }
            const maxCount = Math.max(...Object.values(ageGroups));
            const colors = { '0-18': 'bg-teal-500', '19-30': 'bg-sky-500', '31-45': 'bg-indigo-500', '46-60': 'bg-purple-500', '60+': 'bg-pink-500', 'N/A': 'bg-gray-500' };
            for (const group in ageGroups) {
                const count = ageGroups[group];
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                const barWidth = maxCount > 0 ? (count / maxCount) * 100 : 0;
                chartContainer.append(`<div class="flex items-center"><div class="w-16 text-sm text-gray-300">${group}</div><div class="flex-1 bg-white/10 rounded-full h-6 mr-2"><div class="${colors[group]} h-6 rounded-full" style="width: ${barWidth}%"></div></div><div class="w-20 text-right text-sm font-semibold">${count} (${percentage}%)</div></div>`);
            }
        }

        function switchView(targetId) {
            $('.sidebar').hide();
            $(targetId).show();
            $('.menu-link').removeClass('bg-white/20');
            $(`.menu-link[href="${targetId}"]`).addClass('bg-white/20');
            if (targetId === '#dashboard') loadDashboardData();
            if (targetId === '#admin') setupAdminTab();
        }

        async function showContactsInModal(filtro = 'default', termoBusca = '') {
            lastModalFilter = filtro;
            lastModalSearch = termoBusca;
            try {
                const token = localStorage.getItem('jwtToken');
                const response = await fetch(`/api/contacts?filter=${filtro}&search=${encodeURIComponent(termoBusca)}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.status >= 400) return handleAuthError();
                const contacts = await response.json();
                $('#modalTitle').text("Visualização de Contatos");
                $('#previewContent').html(renderizarTabelaModal(contacts));
                $('#modalFooter').html(`<button onclick='criarListaCsv(${JSON.stringify(contacts)}, "${filtro}")' class="btn-glass text-white font-bold py-2 px-4 rounded">Criar Lista CSV</button>`);
                $('#modalPreview').removeClass('hidden').addClass('flex');
            } catch (error) {
                $.notify('Erro ao carregar contatos.', "error");
            }
        }

        function renderizarTabelaModal(dados) {
            if (!dados || dados.length === 0) return '<p class="text-center text-gray-400 p-8">Nenhum contato encontrado.</p>';
            let tabela = '<div class="overflow-x-auto"><table class="contacts-table w-full text-sm"><thead><tr><th>Nome</th><th>CPF</th><th>Telefone</th><th>Nascimento</th><th>Ações</th></tr></thead><tbody>';
            dados.forEach(contato => {
                const dataNascimentoFormatada = formatarDataParaExibicao(contato.nascimento); // Usa a função de formatação
                tabela += `<tr>
                    <td>${contato.nome || ''}</td>
                    <td>${contato.cpf || ''}</td>
                    <td>${contato.telefone ? `<a href="https://wa.me/${contato.telefone}" target="_blank" class="text-blue-400 hover:underline">${contato.telefone}</a>` : ''}</td>
                    <td>${dataNascimentoFormatada || ''}</td>
                    <td class="p-2 space-x-2"><button onclick="editContact(${contato.id}, '${String(contato.nome || '').replace(/'/g, "\\'")}')" class="text-yellow-400">Editar</button><button onclick="deleteContact(${contato.id})" class="text-red-500">Apagar</button></td>
                </tr>`;
            });
            return tabela + '</tbody></table></div>';
        }
        
        async function setupAdminTab() {
            try {
                const token = localStorage.getItem('jwtToken');
                const response = await fetch('/api/imported-sheets', { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.status >= 400) return handleAuthError();
                const tables = await response.json();
                const selectEl = $('#admin-sheet-select');
                selectEl.empty();
                
                if (tables.length === 0) {
                    selectEl.append('<option value="">Nenhuma lista importada encontrada</option>');
                    $('#admin-dashboard-content').addClass('hidden');
                    $('#admin-no-data').removeClass('hidden');
                } else {
                    selectEl.append('<option value="">Selecione uma lista</option>');
                    tables.forEach(tableName => {
                        const displayName = tableName.replace(/import_|_[0-9]+/g, '');
                        selectEl.append(`<option value="${tableName}">${displayName}</option>`);
                    });
                    $('#admin-no-data').addClass('hidden');
                    selectEl.off('change').on('change', (e) => {
                        const selectedTable = e.target.value;
                        if (selectedTable) {
                            loadAdminDataAndRenderCharts(selectedTable);
                        } else {
                             $('#admin-dashboard-content').addClass('hidden');
                        }
                    });
                }
            } catch (error) {
                $.notify('Erro ao carregar listas para o painel de Administrador.', 'error');
            }
        }

        async function loadAdminDataAndRenderCharts(tableName) {
            try {
                const token = localStorage.getItem('jwtToken');
                const response = await fetch(`/api/imported-sheets/${tableName}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.status >= 400) return handleAuthError();
                currentAdminData = await response.json();
                
                if(currentAdminData.length > 0){
                    renderAdminCharts(currentAdminData);
                    $('#admin-dashboard-content').removeClass('hidden');
                    $('#admin-no-data').addClass('hidden');
                } else {
                    $('#admin-dashboard-content').addClass('hidden');
                    $('#admin-no-data').removeClass('hidden');
                }
            } catch (error) {
                 $.notify(`Erro ao carregar dados da lista ${tableName}.`, 'error');
            }
        }

        function renderAdminCharts(data) {
            // Destruir gráficos antigos para evitar sobreposição
            Object.values(adminCharts).forEach(chart => chart.destroy());

            // 1. Gráfico de Idade
            const ageGroups = { '0-25': 0, '26-40': 0, '41-55': 0, '56+': 0, 'N/A': 0 };
            data.forEach(c => {
                // Usa a nova função de formatação para garantir que a data esteja no formato correto para cálculo
                const formattedNascimento = formatarDataParaExibicao(c.nascimento || c.Nascimento); 
                const age = calculateAge(formattedNascimento); // calculateAge já tem a lógica de inferência de ano
                if (age === null) ageGroups['N/A']++;
                else if (age <= 25) ageGroups['0-25']++;
                else if (age <= 40) ageGroups['26-40']++;
                else if (age <= 55) ageGroups['41-55']++;
                else ageGroups['56+']++;
            });
            const ageCtx = document.getElementById('admin-age-chart').getContext('2d');
            adminCharts.age = new Chart(ageCtx, {
                type: 'bar',
                data: { labels: Object.keys(ageGroups), datasets: [{ label: 'Nº de Contatos', data: Object.values(ageGroups), backgroundColor: 'rgba(79, 70, 229, 0.8)' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // 2. Gráfico de Agência
            const agencyCounts = data.reduce((acc, c) => {
                const agency = c.agencia || c.Agencia || 'N/A';
                acc[agency] = (acc[agency] || 0) + 1;
                return acc;
            }, {});
            const agencyCtx = document.getElementById('admin-agency-chart').getContext('2d');
            adminCharts.agency = new Chart(agencyCtx, {
                type: 'doughnut',
                data: { labels: Object.keys(agencyCounts), datasets: [{ data: Object.values(agencyCounts), backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });

            // 3. Gráfico de DDD
            const dddCounts = data.reduce((acc, c) => {
                const phone = c.telefone || c.Telefone || c.TEL_01;
                if (phone && String(phone).length >= 2) {
                    const ddd = String(phone).substring(0, 2);
                    acc[ddd] = (acc[ddd] || 0) + 1;
                }
                return acc;
            }, {});
            const dddCtx = document.getElementById('admin-ddd-chart').getContext('2d');
            adminCharts.ddd = new Chart(dddCtx, {
                type: 'bar',
                data: { labels: Object.keys(dddCounts), datasets: [{ label: 'Nº de Contatos', data: Object.values(dddCounts), backgroundColor: 'rgba(234, 179, 8, 0.8)' }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
            });
        }

        $('#download-csv-btn').on('click', () => {
            const tableName = $('#admin-sheet-select').val();
            if (!tableName || currentAdminData.length === 0) {
                return $.notify('Selecione uma lista com dados para baixar.', 'warn');
            }
            
            const numRows = parseInt($('#download-rows-input').val()) || currentAdminData.length;
            const dataToDownload = currentAdminData.slice(0, numRows);
            
            if (dataToDownload.length > 0) {
                const headers = Object.keys(dataToDownload[0]);
                let csv = headers.join(";") + "\n";
                dataToDownload.forEach(item => {
                    const row = headers.map(header => `"${(item[header] || "").toString().replace(/"/g, '""')}"`);
                    csv += row.join(";") + "\n";
                });
                const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `${tableName}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        // Funções adicionadas para o preview
        function abrirPreview() {
            if (tabelaPreview) {
                $('#modalTitle').text('Pré-visualização da Lista');
                $('#previewContent').html(tabelaPreview);
                $('#modalFooter').html('');
                $('#modalPreview').removeClass('hidden').addClass('flex');
            } else {
                $.notify('Nenhuma planilha carregada para pré-visualizar!', { className: "warn", position: "top center" });
            }
        }

        function fecharPreview() {
            $('#modalPreview').removeClass('flex').addClass('hidden');
            $('#previewContent').empty();
            $('#modalFooter').empty();
        }

        function previewPlanilha(event) {
            const file = event.target.files[0];
            if (!file) { tabelaPreview = ''; return; }
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, defval: "" });
                    if (!json || json.length <= 1) {
                        tabelaPreview = '<p class="text-center text-gray-400 p-8">A planilha está vazia ou tem apenas cabeçalhos.</p>';
                        $.notify("A planilha parece estar vazia.", { className: "warn", position: "top center" });
                        return;
                    }
                    const maxCols = json.reduce((max, row) => Math.max(max, row.length), 0);
                    let table = '<div class="overflow-x-auto"><table class="contacts-table w-full text-sm"><thead><tr>';
                    table += '<th class="p-2 sticky top-0 bg-gray-700 text-center">Índice</th>';
                    if (json.length > 0) {
                        for (let colIndex = 0; colIndex < maxCols; colIndex++) {
                            table += `<th class="p-2 sticky top-0 bg-gray-700">${json[0][colIndex] || ''}</th>`;
                        }
                    }
                    table += '</tr></thead><tbody>';
                    for (let rowIndex = 1; rowIndex < json.length; rowIndex++) {
                        const rowData = json[rowIndex];
                        if (!rowData.some(cell => cell && String(cell).trim() !== '')) continue;
                        table += '<tr>';
                        table += `<td class="p-2 text-center font-semibold bg-gray-800">${rowIndex + 1}</td>`;
                        for (let colIndex = 0; colIndex < maxCols; colIndex++) {
                            // Aplica a formatação de data para a coluna "Nascimento" se for identificada
                            const headerValue = (json[0][colIndex] || '').toLowerCase();
                            if (headerValue.includes('nascimento') || headerValue.includes('data_nascimento') || headerValue.includes('dt_nascimento')) {
                                table += `<td class="p-2">${formatarDataParaExibicao(String(rowData[colIndex] || '').trim())}</td>`;
                            } else {
                                table += `<td class="p-2">${String(rowData[colIndex] || '').trim()}</td>`;
                            }
                        }
                        table += '</tr>';
                    }
                    table += '</tbody></table></div>';
                    tabelaPreview = table;
                    $.notify("Pré-visualização pronta.", { className: "success", position: "top center" });
                } catch (error) {
                    console.error("Erro ao ler a planilha:", error);
                    $.notify("Arquivo inválido ou corrompido.", { className: "error", position: "top center" });
                    tabelaPreview = '';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function handleSearch() {
            const searchTerm = $('#searchInput').val();
            showContactsInModal('default', searchTerm);
        }

        async function editContact(contactId, currentName) {
            const newName = prompt("Digite o novo nome para o contato:", currentName);
            if (newName && newName.trim() !== '' && newName !== currentName) {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch(`/api/contacts/${contactId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ nome: newName })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        $.notify(result.message, { className: "success", position: "top center" });
                        showContactsInModal(lastModalFilter, lastModalSearch);
                        loadDashboardData();
                    } else {
                        throw new Error(result.message || 'Falha ao atualizar contato.');
                    }
                } catch (error) {
                    $.notify(error.message, { className: "error", position: "top center" });
                }
            }
        }

        async function deleteContact(contactId) {
            if (confirm("Tem certeza que deseja apagar este contato? Esta ação não pode ser desfeita.")) {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch(`/api/contacts/${contactId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (response.ok) {
                        $.notify(result.message, { className: "success", position: "top center" });
                        showContactsInModal(lastModalFilter, lastModalSearch);
                        loadDashboardData();
                    } else {
                        throw new Error(result.message || 'Falha ao apagar contato.');
                    }
                } catch (error) {
                    $.notify(error.message, { className: "error", position: "top center" });
                }
            }
        }

        function criarListaCsv(dados, filtro) {
            if (!dados || !dados.length) return $.notify("Nenhum dado para exportar.", { className: "warn", position: "top center" });
            const headers = ["nome", "cpf", "agencia", "nascimento", "DDD", "Telefone", "data_envio_ultima_mensagem"];
            let csv = headers.join(";") + "\n";
            dados.forEach(item => {
                const telefone = (item.telefone || "").toString();
                const ddd = telefone.slice(2, 4);
                const tel = telefone.slice(4);
                // Garante que a data de nascimento seja formatada corretamente ao exportar
                const nascimentoFormatado = formatarDataParaExibicao(item.nascimento);
                const linha = [`"${(item.nome || "").replace(/"/g, '""')}"`, `"${(item.cpf || "").replace(/"/g, '""')}"`, `"${(item.agencia || "").replace(/"/g, '""')}"`, `"${nascimentoFormatado || ""}"`, `"${ddd}"`, `"${tel}"`, `"${(item.data_envio_ultima_mensagem || "").replace(/"/g, '""')}"`];
                csv += linha.join(";") + "\n";
            });
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${filtro}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>