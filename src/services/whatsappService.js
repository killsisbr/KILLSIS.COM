// src/services/whatsappService.js
const { Client, LocalAuth } = require('whatsapp-web.js');
const qrcode = require('qrcode');
const path = require('path');
const fs = require('fs');
const dbService = require('./databaseService');
// Importe os novos servi√ßos
const geminiChatService = require('./geminiChatService.js');
const geminiFileService = require('./geminiFileService.js');

const clients = {};
const userDir = path.join(__dirname, '..', '..', 'user');
let centralBotWhatsappNumber = process.env.CENTRAL_BOT_NUMBER || '554284299123';

if (!fs.existsSync(userDir)) {
    fs.mkdirSync(userDir);
}

const sanitizeIdentifier = (id) => {
    if (!id || typeof id !== 'string') return '';
    return id.replace(/[\\/:\s]/g, '-');
}

/**
 * Inicializa um cliente WhatsApp para um usu√°rio.
 * @param {string} sessionIdentifier - O identificador da sess√£o (geralmente o username).
 * @param {object|null} userObject - O objeto do usu√°rio vindo do banco de dados.
 * @param {object|null} socket - O objeto de socket da conex√£o ativa, se houver.
 * @param {boolean} isCentralBot - Flag para identificar se √© o bot central.
 */
function initializeClient(sessionIdentifier, userObject, socket, isCentralBot = false) {
    const sanitizedIdentifier = sanitizeIdentifier(sessionIdentifier);
    if (!sanitizedIdentifier) {
        console.error("Erro: sessionIdentifier inv√°lido ou n√£o fornecido para initializeClient.");
        if (socket) {
            socket.emit('error', 'Ocorreu um erro interno ao iniciar a sess√£o (ID de usu√°rio inv√°lido).');
        }
        return;
    }

    
    // --- IN√çCIO DA CORRE√á√ÉO ---
    // Verifica se um cliente j√° existe e se ele est√° em um estado funcional (n√£o √© um "zumbi").
    if (clients[sanitizedIdentifier]) {
        const existingClient = clients[sanitizedIdentifier];
        
        // A presen√ßa de 'pupBrowser' √© um bom indicador de que o cliente n√£o foi destru√≠do.
        if (existingClient.pupBrowser) {
            console.log(`Sess√£o para ${sanitizedIdentifier} j√° existe e est√° ativa. Tentando reconectar.`);
            if (socket) {
                existingClient.getState().then(state => {
                    if (state === 'CONNECTED') {
                        socket.emit('ready');
                        socket.emit('log', `Reconectado √† sess√£o existente.`);
                    }
                }).catch(err => {
                    console.error(`Erro ao obter estado do cliente existente para ${sanitizedIdentifier}:`, err);
                });
            }
            return; // Impede a reinicializa√ß√£o se o cliente estiver saud√°vel.
        } else {
            // Se o cliente existe mas n√£o tem 'pupBrowser', √© um zumbi.
            console.warn(`[FIX] Sess√£o "zumbi" para ${sanitizedIdentifier} encontrada. Removendo para recriar.`);
            delete clients[sanitizedIdentifier];
        }
    }

    console.log(`Inicializando sess√£o para: ${sanitizedIdentifier} (Original: ${sessionIdentifier}, Central Bot: ${isCentralBot})`);

    const client = new Client({
        puppeteer: {
            args: ['--no-sandbox', '--disable-setuid-sandbox'],
            headless: true,
        },
        authStrategy: new LocalAuth({ clientId: sanitizedIdentifier, dataPath: userDir })
    });

    client.isUserClient = !isCentralBot;
    client.whatsappNumber = null;
    // O objeto de usu√°rio agora √© passado diretamente, garantindo que ele exista mesmo sem um socket.
    client.user = userObject;

    client.on('qr', (qr) => {
        if (isCentralBot) {
            console.log(`QR Code para BOT CENTRAL:`);
            qrcode.toString(qr, { type: 'terminal', small: true }, (err, url) => {
                if (err) console.error(`Erro ao gerar QR Code para BOT CENTRAL:`, err);
                console.log(url);
            });
        } else if (socket) {
            // S√≥ emite QR Code para o frontend se houver um socket conectado (ou seja, um usu√°rio na p√°gina)
            console.log(`QR Code gerado para ${sanitizedIdentifier}`);
            socket.emit('log', 'QR Code gerado. Por favor, escaneie para conectar.');
            qrcode.toDataURL(qr, (err, url) => {
                if (err) {
                    console.error(`Erro ao gerar QR Code para ${sanitizedIdentifier}:`, err);
                    return socket.emit('error', 'Erro ao gerar QR Code.');
                }
                socket.emit('qr', url);
            });
        }
    });

    client.on('ready', async () => {
        const whatsappNumber = client.info.wid.user;
        client.whatsappNumber = whatsappNumber;

        console.log(`Cliente ${sanitizedIdentifier} conectado! N√∫mero do WhatsApp: ${whatsappNumber}`);
        if (socket) {
            socket.emit('ready');
            socket.emit('log', `Conectado com sucesso com o n√∫mero: ${whatsappNumber}`);
        }

        try {
            if (isCentralBot) {
                centralBotWhatsappNumber = whatsappNumber;
                console.log(`BOT CENTRAL conectado com o n√∫mero: ${centralBotWhatsappNumber}`);
            } else {
                console.log(`[WhatsApp Service] Cliente de usu√°rio '${sanitizedIdentifier}' conectado. Verificando associa√ß√£o de n√∫mero.`);
                // A verifica√ß√£o usa 'client.user.id' pois o objeto vem direto do DB na inicializa√ß√£o.
                if (client.user && (client.user.id || client.user.userId)) {
                    const userId = client.user.id || client.user.userId;
                    console.log(`[WhatsApp Service] Usu√°rio (ID: ${userId}, Username: ${client.user.username}) encontrado. Tentando atualizar o n√∫mero...`);
                    
                    dbService.updateUserWhatsappNumber(userId, whatsappNumber);
                    
                    client.user.command_whatsapp_number = whatsappNumber;
                    client.user.clientId = whatsappNumber;
                    
                    console.log(`[WhatsApp Service] SUCESSO: Associa√ß√£o no DB para ${client.user.username} conclu√≠da. N√∫mero salvo: ${whatsappNumber}`);
                } else {
                    console.error(`[WhatsApp Service] ERRO CR√çTICO: Cliente '${sanitizedIdentifier}' conectado, mas o objeto 'client.user' est√° faltando ou incompleto.`);
                    console.error('[WhatsApp Service] O n√∫mero do WhatsApp N√ÉO ser√° salvo no banco de dados. Detalhes do client.user:', client.user);
                    if(socket) {
                        socket.emit('error', 'Conectado ao WhatsApp, mas falha ao associar o n√∫mero √† sua conta. Por favor, tente fazer login novamente.');
                    }
                }
            }

            dbService.getUserDb(whatsappNumber);
            console.log(`Estrutura de dados garantida para o cliente: ${whatsappNumber}`);

            if (socket) {
                socket.emit('log', 'Configura√ß√£o inicial conclu√≠da. O sistema est√° pronto.');
            }

        } catch (error) {
            console.error(`Erro ao configurar o cliente ${sanitizedIdentifier} ap√≥s a conex√£o:`, error);
            if (socket) {
                socket.emit('error', 'Ocorreu um erro ao salvar a configura√ß√£o do seu n√∫mero.');
            }
        }
    });

    client.on('disconnected', async (reason) => {
        console.log(`Cliente ${sanitizedIdentifier} desconectado:`, reason);
        if (clients[sanitizedIdentifier]) {
            try {
                await clients[sanitizedIdentifier].destroy();
                console.log(`Cliente ${sanitizedIdentifier} destru√≠do com sucesso.`);
            } catch (e) {
                console.error(`Erro ao destruir o cliente ${sanitizedIdentifier}:`, e);
            }
            delete clients[sanitizedIdentifier];
        }
        if (isCentralBot) {
            centralBotWhatsappNumber = null;
        }
        if (socket) {
            socket.emit('disconnected');
            socket.emit('log', `Desconectado. Por favor, atualize a p√°gina.`);
        }
    });

    client.on('message_create', async (message) => {
        if (message.fromMe && message.body.includes('üîç')) {
            const clientPhoneNumber = message.to.replace('@c.us', '').substring(2);
            const searchCommand = `!buscar ${clientPhoneNumber}`;
            await client.sendMessage(getCentralBotWhatsappNumber() + '@c.us', searchCommand);
            console.log(`[Central Bot] Disparado comando de busca para ${clientPhoneNumber} via emoji.`);
            return;
        }
    });

    client.on('message', async (message) => {
         const userMessage = message.body;
    const userId = message.from; // ID √∫nico do usu√°rio

    // --- Rota para o Chatbot ---
    // Responde se a mensagem come√ßar com '!ia'
    if (userMessage.toLowerCase().startsWith('!ia ')) {
        const prompt = userMessage.substring(4); // Pega o texto ap√≥s '!ia '
        
        message.reply('ü§ñ Pensando...'); // Feedback para o usu√°rio

        const aiResponse = await geminiChatService.sendMessageToAI(userId, prompt);
        message.reply(aiResponse);
        return;
    }

    // --- Rota para An√°lise de Imagem ---
    // Responde se o usu√°rio enviar uma imagem com uma legenda come√ßando com '!analisar'
    if (message.hasMedia && message.body.toLowerCase().startsWith('!analisar ')) {
        const prompt = message.body.substring(10); // Pega o texto ap√≥s '!analisar '
        
        message.reply('üñºÔ∏è Analisando a imagem...');

        try {
            const media = await message.downloadMedia();
            if (media && media.mimetype.startsWith('image/')) {
                // Salva a imagem temporariamente
                const filePath = `./temp_media.${media.mimetype.split('/')[1]}`;
                fs.writeFileSync(filePath, Buffer.from(media.data, 'base64'));

                // Chama o servi√ßo de an√°lise
                const analysisResult = await geminiFileService.analyzeFile(prompt, filePath, media.mimetype);
                message.reply(analysisResult);

                // Apaga o arquivo tempor√°rio
                fs.unlinkSync(filePath);
            } else {
                message.reply("Por favor, envie uma imagem v√°lida para an√°lise.");
            }
        } catch (error) {
            console.error("Erro ao baixar ou analisar m√≠dia:", error);
            message.reply("Ocorreu um erro ao processar sua imagem.");
        }
        return;
    }
        const commandService = require('./commandService');
        if (!isCentralBot) {
            return;
        }
        if (!message.from.includes('@c.us')) return;

        try {
            const senderNumber = message.from.replace('@c.us', '');
            console.log(`[Central Bot] Mensagem recebida de ${senderNumber}: ${message.body}`);

            let user = null;
            for (const key in clients) {
                const c = clients[key];
                if (c.isUserClient && c.whatsappNumber === senderNumber) {
                    user = c.user;
                    console.log(`[Central Bot] Usu√°rio encontrado na sess√£o ativa: ${user.username}`);
                    break;
                }
            }

            if (!user) {
                console.log(`[Central Bot] Usu√°rio n√£o encontrado na sess√£o ativa. Consultando banco de dados...`);
                user = dbService.findUserByWhatsappNumber(senderNumber);
            }

            if (!user) {
                if (message.body.startsWith('.') || message.body.startsWith('!')) {
                    console.log(`[Central Bot] Comando de n√∫mero desconhecido ${senderNumber}. Respondendo e ignorando.`);
                    return message.reply('‚ùå Seu n√∫mero de WhatsApp n√£o est√° associado a uma conta. Por favor, fa√ßa login no painel web primeiro para registrar seu n√∫mero.');
                }
                console.log(`[Central Bot] Ignorando mensagem de n√∫mero desconhecido ${senderNumber}.`);
                return;
            }

            console.log(`[Central Bot] Processando comando para o usu√°rio: ${user.username}`);
            dbService.getUserDb(senderNumber);
            const userSanitizedIdentifier = sanitizeIdentifier(user.username);
            const userSocket = clients[userSanitizedIdentifier]?.socket || null;
            await commandService.handleCommand(message, user, senderNumber, userSocket, getCentralBotWhatsappNumber());

        } catch (error) {
            console.error('[Central Bot] Erro no manipulador de mensagens:', error);
            await message.reply('‚ùå Ocorreu um erro interno ao processar seu comando.');
        }
    });

    client.initialize().catch(err => {
        console.error(`Falha ao inicializar cliente para ${sanitizedIdentifier}:`, err);
        if (socket) {
            socket.emit('error', 'Falha ao inicializar a sess√£o do WhatsApp.');
        }
    });

    client.socket = socket;
    clients[sanitizedIdentifier] = client;
    console.log(`Cliente para ${sanitizedIdentifier} adicionado √† lista de clientes ativos.`);
}

function getClient(id) {
    const sanitizedId = sanitizeIdentifier(id);
    return clients[sanitizedId];
}

function getCentralBotWhatsappNumber() {
    return centralBotWhatsappNumber;
}

process.on('exit', dbService.closeAllConnections);
process.on('SIGINT', () => process.exit());
process.on('SIGTERM', () => process.exit());

module.exports = {
    initializeClient,
    getClient,
    clients,
    getCentralBotWhatsappNumber,
    sanitizeIdentifier
};
